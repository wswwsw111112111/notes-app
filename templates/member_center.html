{% extends "base.html" %}
{% block title %}ä¼šå‘˜ä¸­å¿ƒ{% endblock %}

{% block content %}
<style>
.member-container { max-width: 1200px; margin: 20px auto; padding: 20px; }
.page-header { text-align: center; margin-bottom: 40px; }
.page-header h1 { color: #333; margin-bottom: 10px; }
.page-header .subtitle { color: #666; font-size: 1.1em; }

/* ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ */
.user-info-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
.user-info-card h2 { margin: 0 0 20px 0; font-size: 1.8em; }
.user-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
.stat-item { background-color: rgba(255,255,255,0.2); border-radius: 10px; padding: 15px; text-align: center; }
.stat-item .stat-value { font-size: 2em; font-weight: bold; margin-bottom: 5px; }
.stat-item .stat-label { font-size: 0.9em; opacity: 0.9; }

/* ç­‰çº§å¡ç‰‡ */
.levels-section { margin-bottom: 40px; }
.section-title { font-size: 1.5em; color: #333; margin-bottom: 20px; border-left: 4px solid #667eea; padding-left: 15px; }
.levels-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
.level-card { background-color: white; border-radius: 10px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.3s, box-shadow 0.3s; position: relative; overflow: hidden; }
.level-card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.2); }
.level-card.current { border: 3px solid #667eea; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
.level-card.current::before { content: 'å½“å‰ç­‰çº§'; position: absolute; top: 10px; right: 10px; background-color: #667eea; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.8em; font-weight: bold; }
.level-badge { display: inline-block; padding: 8px 20px; border-radius: 25px; font-weight: bold; margin-bottom: 15px; font-size: 1.1em; }
.level-badge.level-0 { background-color: #e0e0e0; color: #666; }
.level-badge.level-1 { background-color: #81c784; color: white; }
.level-badge.level-2 { background-color: #64b5f6; color: white; }
.level-badge.level-3 { background-color: #ffd740; color: #333; }
.level-features { list-style: none; padding: 0; margin: 15px 0; }
.level-features li { padding: 8px 0; border-bottom: 1px dashed #ddd; color: #555; }
.level-features li:last-child { border-bottom: none; }
.level-features li::before { content: 'âœ“ '; color: #4caf50; font-weight: bold; margin-right: 8px; }
.level-price { font-size: 1.3em; color: #ff6b6b; font-weight: bold; margin: 15px 0; }
.level-action { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 1em; font-weight: bold; cursor: pointer; transition: all 0.3s; }
.level-action.exchange { background-color: #ff9800; color: white; }
.level-action.exchange:hover { background-color: #e68900; }
.level-action.recharge { background-color: #4caf50; color: white; }
.level-action.recharge:hover { background-color: #45a049; }
.level-action:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.6; }

/* ç§¯åˆ†è®°å½• */
.points-section { margin-bottom: 40px; }
.points-table { width: 100%; background-color: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
.points-table table { width: 100%; border-collapse: collapse; }
.points-table th, .points-table td { padding: 15px; text-align: left; border-bottom: 1px solid #f0f0f0; }
.points-table th { background-color: #f8f9fa; font-weight: bold; color: #333; }
.points-table tr:hover { background-color: #f5f5f5; }
.points-positive { color: #4caf50; font-weight: bold; }
.points-negative { color: #f44336; font-weight: bold; }
.no-records { text-align: center; padding: 40px; color: #999; font-style: italic; }

/* å…‘æ¢ç è¾“å…¥ */
.redeem-section { background-color: white; border-radius: 10px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 40px; }
.redeem-input-group { display: flex; gap: 10px; max-width: 500px; margin: 0 auto; }
.redeem-input { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; }
.redeem-btn { padding: 12px 30px; background-color: #667eea; color: white; border: none; border-radius: 8px; font-size: 1em; font-weight: bold; cursor: pointer; }
.redeem-btn:hover { background-color: #5568d3; }

/* å“åº”å¼ */
@media (max-width: 768px) {
    .levels-grid { grid-template-columns: 1fr; }
    .user-stats { grid-template-columns: 1fr; }
    .redeem-input-group { flex-direction: column; }
}
</style>

<div class="member-container">
    <div class="page-header">
        <h1>ğŸ’ ä¼šå‘˜ä¸­å¿ƒ</h1>
        <p class="subtitle">ç®¡ç†æ‚¨çš„ä¼šå‘˜æƒç›Šå’Œç§¯åˆ†</p>
    </div>

    <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
    <div class="user-info-card">
        <h2>ğŸ‘‹ æ‚¨å¥½ï¼Œ{{ current_user.username }}</h2>
        <div class="user-stats">
            <div class="stat-item">
                <div class="stat-value">Lv{{ current_user.user_level }}</div>
                <div class="stat-label">{{ current_user.get_level_config().name }}</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ current_user.points }}</div>
                <div class="stat-label">å½“å‰ç§¯åˆ†</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ "%.2f"|format(current_user.storage_limit_gb) }}GB</div>
                <div class="stat-label">å­˜å‚¨ç©ºé—´</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ current_user.retention_days }}å¤©</div>
                <div class="stat-label">ç¬”è®°ä¿ç•™æœŸ</div>
            </div>
        </div>
    </div>

    <!-- å…‘æ¢ç è¾“å…¥ -->
    <div class="redeem-section">
        <h3 class="section-title">ğŸŸï¸ å…‘æ¢ç å…‘æ¢</h3>
        <p style="text-align: center; color: #666; margin-bottom: 20px;">è¾“å…¥å…‘æ¢ç å‡çº§æ‚¨çš„ä¼šå‘˜ç­‰çº§</p>
        <div class="redeem-input-group">
            <input type="text" id="redeemCodeInput" class="redeem-input" placeholder="è¯·è¾“å…¥å…‘æ¢ç " maxlength="20" style="text-transform: uppercase;" />
            <button class="redeem-btn" onclick="submitRedeemCode()">ç«‹å³å…‘æ¢</button>
        </div>
    </div>

    <!-- ç­‰çº§é€‰æ‹© -->
    <div class="levels-section">
        <h3 class="section-title">ğŸ“Š ä¼šå‘˜ç­‰çº§</h3>
        <div class="levels-grid">
            {% for level, config in user_levels.items() %}
            <div class="level-card {% if current_user.user_level == level %}current{% endif %}">
                <div class="level-badge level-{{ level }}">
                    Lv{{ level }} - {{ config.name }}
                </div>
                <div style="color: #666; margin-bottom: 15px;">
                    <strong>ğŸ“¦ å­˜å‚¨ç©ºé—´ï¼š</strong>{{ config.storage_gb }}GB<br>
                    <strong>â° ä¿ç•™æœŸé™ï¼š</strong>{{ config.retention_days }}å¤©
                </div>
                <ul class="level-features">
                    {% for feature in config.features %}
                    <li>{{ feature }}</li>
                    {% endfor %}
                </ul>
                
                {% if current_user.user_level >= level %}
                    <button class="level-action" disabled>å·²æ‹¥æœ‰</button>
                {% elif level == 1 %}
                    <div class="level-price">éœ€è¦ {{ config.points_required }} ç§¯åˆ†</div>
                    <button class="level-action exchange" onclick="exchangePoints({{ level }})" 
                            {% if current_user.points < config.points_required %}disabled{% endif %}>
                        {% if current_user.points >= config.points_required %}
                            ç§¯åˆ†å…‘æ¢
                        {% else %}
                            ç§¯åˆ†ä¸è¶³
                        {% endif %}
                    </button>
                {% else %}
                    <div class="level-price">Â¥ {{ config.price }} {% if level == 2 %}/ æœˆ{% else %}/ å¹´{% endif %}</div>
                    <button class="level-action recharge" onclick="openRecharge({{ level }})">
                        å……å€¼å¼€é€š
                    </button>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- ç§¯åˆ†è·å–è¯´æ˜ -->
    <div style="background-color: #fff3e0; border-left: 4px solid #ff9800; padding: 20px; border-radius: 8px; margin-bottom: 40px;">
        <h4 style="margin-top: 0; color: #e65100;">ğŸ’¡ å¦‚ä½•è·å–ç§¯åˆ†ï¼Ÿ</h4>
        <ul style="margin: 10px 0; padding-left: 20px; color: #666;">
            <li><strong>æ³¨å†Œå¥–åŠ±ï¼š</strong>æ–°ç”¨æˆ·æ³¨å†Œå³é€ 10 ç§¯åˆ†</li>
            <li><strong>æ¯æ—¥ç™»å½•ï¼š</strong>æ¯å¤©é¦–æ¬¡ç™»å½•è·å¾— 1 ç§¯åˆ†</li>
            <li><strong>åˆ›å»ºç¬”è®°ï¼š</strong>æ¯åˆ›å»ºä¸€ç¯‡ç¬”è®°è·å¾— 2 ç§¯åˆ†ï¼ˆå¾…å¼€å‘ï¼‰</li>
            <li><strong>åˆ†äº«ç¬”è®°ï¼š</strong>æ¯æ¬¡æˆåŠŸåˆ†äº«è·å¾— 5 ç§¯åˆ†ï¼ˆå¾…å¼€å‘ï¼‰</li>
            <li><strong>æ´»åŠ¨å¥–åŠ±ï¼š</strong>å‚ä¸å¹³å°æ´»åŠ¨å¯è·å¾—é¢å¤–ç§¯åˆ†</li>
            <li><strong>ç®¡ç†å‘˜èµ é€ï¼š</strong>é€šè¿‡ç‰¹æ®Šæ¸ é“å¯è·å¾—ç§¯åˆ†å¥–åŠ±</li>
        </ul>
    </div>

    <!-- ç§¯åˆ†è®°å½• -->
    <div class="points-section">
        <h3 class="section-title">ğŸ“œ ç§¯åˆ†è®°å½•ï¼ˆæœ€è¿‘20æ¡ï¼‰</h3>
        {% if point_logs %}
        <div class="points-table">
            <table>
                <thead>
                    <tr>
                        <th>æ—¶é—´</th>
                        <th>å˜åŠ¨</th>
                        <th>åŸå› </th>
                        <th>ä½™é¢</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in point_logs %}
                    <tr>
                        <td>{{ log.created_at|beijing_time }}</td>
                        <td>
                            {% if log.amount > 0 %}
                                <span class="points-positive">+{{ log.amount }}</span>
                            {% else %}
                                <span class="points-negative">{{ log.amount }}</span>
                            {% endif %}
                        </td>
                        <td>{{ log.reason }}</td>
                        <td><strong>{{ log.balance_after }}</strong></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="no-records">æš‚æ— ç§¯åˆ†è®°å½•</div>
        {% endif %}
    </div>

    <div style="text-align: center; margin-top: 40px;">
        <a href="{{ url_for('notes_page') }}" style="color: #667eea; text-decoration: none; font-size: 1.1em;">
            â† è¿”å›ç¬”è®°é¡µé¢
        </a>
    </div>
</div>

<script>
const csrfToken = "{{ csrf_token() }}";

// å…‘æ¢ç å…‘æ¢
async function submitRedeemCode() {
    const code = document.getElementById('redeemCodeInput').value.trim().toUpperCase();
    
    if (!code) {
        alert('è¯·è¾“å…¥å…‘æ¢ç ï¼');
        return;
    }
    
    try {
        const response = await fetch('/redeem_code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({ code: code })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('ğŸ‰ ' + result.message);
            location.reload();
        } else {
            alert('âŒ ' + result.error);
        }
    } catch (error) {
        alert('å…‘æ¢å¤±è´¥ï¼š' + error.message);
    }
}

// ç§¯åˆ†å…‘æ¢ä¼šå‘˜
async function exchangePoints(level) {
    const levelName = {{ user_levels|tojson }};
    const config = levelName[level];
    
    if (!confirm(`ç¡®å®šè¦ä½¿ç”¨ ${config.points_required} ç§¯åˆ†å…‘æ¢${config.name}å—ï¼Ÿ`)) {
        return;
    }
    
    try {
        const response = await fetch('/exchange_points', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({ level: level })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('ğŸ‰ ' + result.message);
            location.reload();
        } else {
            alert('âŒ ' + result.error);
        }
    } catch (error) {
        alert('å…‘æ¢å¤±è´¥ï¼š' + error.message);
    }
}

// å……å€¼å¼€é€šä¼šå‘˜
async function openRecharge(level) {
    const levelName = {{ user_levels|tojson }};
    const config = levelName[level];
    
    alert(`ğŸ’° å……å€¼åŠŸèƒ½å¼€å‘ä¸­\n\n${config.name}\nä»·æ ¼ï¼šÂ¥${config.price}\n\nè¯·è”ç³»ç®¡ç†å‘˜æ‰‹åŠ¨å¼€é€šä¼šå‘˜`);
    
    // å®é™…ä½¿ç”¨æ—¶ï¼Œè¿™é‡Œåº”è¯¥è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
    // window.location.href = '/payment?level=' + level;
}

// å›è½¦é”®æäº¤å…‘æ¢ç 
document.getElementById('redeemCodeInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        submitRedeemCode();
    }
});
</script>

{% endblock %}

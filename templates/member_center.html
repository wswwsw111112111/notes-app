{% extends "base.html" %}
{% block title %}会员中心{% endblock %}

{% block content %}
<style>
.member-container { max-width: 1200px; margin: 20px auto; padding: 20px; }
.page-header { text-align: center; margin-bottom: 40px; }
.page-header h1 { color: #333; margin-bottom: 10px; }
.page-header .subtitle { color: #666; font-size: 1.1em; }

/* 用户信息卡片 */
.user-info-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
.user-info-card h2 { margin: 0 0 20px 0; font-size: 1.8em; }
.user-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
.stat-item { background-color: rgba(255,255,255,0.2); border-radius: 10px; padding: 15px; text-align: center; }
.stat-item .stat-value { font-size: 2em; font-weight: bold; margin-bottom: 5px; }
.stat-item .stat-label { font-size: 0.9em; opacity: 0.9; }

/* 等级卡片 */
.levels-section { margin-bottom: 40px; }
.section-title { font-size: 1.5em; color: #333; margin-bottom: 20px; border-left: 4px solid #667eea; padding-left: 15px; }
.levels-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
.level-card { background-color: white; border-radius: 10px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.3s, box-shadow 0.3s; position: relative; overflow: hidden; }
.level-card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.2); }
.level-card.current { border: 3px solid #667eea; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
.level-card.current::before { content: '当前等级'; position: absolute; top: 10px; right: 10px; background-color: #667eea; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.8em; font-weight: bold; }
.level-badge { display: inline-block; padding: 8px 20px; border-radius: 25px; font-weight: bold; margin-bottom: 15px; font-size: 1.1em; }
.level-badge.level-0 { background-color: #e0e0e0; color: #666; }
.level-badge.level-1 { background-color: #81c784; color: white; }
.level-badge.level-2 { background-color: #64b5f6; color: white; }
.level-badge.level-3 { background-color: #ffd740; color: #333; }
.level-features { list-style: none; padding: 0; margin: 15px 0; }
.level-features li { padding: 8px 0; border-bottom: 1px dashed #ddd; color: #555; }
.level-features li:last-child { border-bottom: none; }
.level-features li::before { content: '✓ '; color: #4caf50; font-weight: bold; margin-right: 8px; }
.level-price { font-size: 1.3em; color: #ff6b6b; font-weight: bold; margin: 15px 0; }
.level-action { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 1em; font-weight: bold; cursor: pointer; transition: all 0.3s; }
.level-action.exchange { background-color: #ff9800; color: white; }
.level-action.exchange:hover { background-color: #e68900; }
.level-action.recharge { background-color: #4caf50; color: white; }
.level-action.recharge:hover { background-color: #45a049; }
.level-action:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.6; }

/* 积分记录 */
.points-section { margin-bottom: 40px; }
.points-table { width: 100%; background-color: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
.points-table table { width: 100%; border-collapse: collapse; }
.points-table th, .points-table td { padding: 15px; text-align: left; border-bottom: 1px solid #f0f0f0; }
.points-table th { background-color: #f8f9fa; font-weight: bold; color: #333; }
.points-table tr:hover { background-color: #f5f5f5; }
.points-positive { color: #4caf50; font-weight: bold; }
.points-negative { color: #f44336; font-weight: bold; }
.no-records { text-align: center; padding: 40px; color: #999; font-style: italic; }

/* 兑换码输入 */
.redeem-section { background-color: white; border-radius: 10px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 40px; }
.redeem-input-group { display: flex; gap: 10px; max-width: 500px; margin: 0 auto; }
.redeem-input { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em; }
.redeem-btn { padding: 12px 30px; background-color: #667eea; color: white; border: none; border-radius: 8px; font-size: 1em; font-weight: bold; cursor: pointer; }
.redeem-btn:hover { background-color: #5568d3; }

/* 响应式 */
@media (max-width: 768px) {
    .levels-grid { grid-template-columns: 1fr; }
    .user-stats { grid-template-columns: 1fr; }
    .redeem-input-group { flex-direction: column; }
}
</style>

<div class="member-container">
    <div class="page-header">
        <h1>💎 会员中心</h1>
        <p class="subtitle">管理您的会员权益和积分</p>
    </div>

    <!-- 用户信息卡片 -->
    <div class="user-info-card">
        <h2>👋 您好，{{ current_user.username }}</h2>
        <div class="user-stats">
            <div class="stat-item">
                <div class="stat-value">Lv{{ current_user.user_level }}</div>
                <div class="stat-label">{{ current_user.get_level_config().name }}</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ current_user.points }}</div>
                <div class="stat-label">当前积分</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ "%.2f"|format(current_user.storage_limit_gb) }}GB</div>
                <div class="stat-label">存储空间</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ current_user.retention_days }}天</div>
                <div class="stat-label">笔记保留期</div>
            </div>
        </div>
    </div>

    <!-- 兑换码输入 -->
    <div class="redeem-section">
        <h3 class="section-title">🎟️ 兑换码兑换</h3>
        <p style="text-align: center; color: #666; margin-bottom: 20px;">输入兑换码升级您的会员等级</p>
        <div class="redeem-input-group">
            <input type="text" id="redeemCodeInput" class="redeem-input" placeholder="请输入兑换码" maxlength="20" style="text-transform: uppercase;" />
            <button class="redeem-btn" onclick="submitRedeemCode()">立即兑换</button>
        </div>
    </div>

    <!-- 等级选择 -->
    <div class="levels-section">
        <h3 class="section-title">📊 会员等级</h3>
        <div class="levels-grid">
            {% for level, config in user_levels.items() %}
            <div class="level-card {% if current_user.user_level == level %}current{% endif %}">
                <div class="level-badge level-{{ level }}">
                    Lv{{ level }} - {{ config.name }}
                </div>
                <div style="color: #666; margin-bottom: 15px;">
                    <strong>📦 存储空间：</strong>{{ config.storage_gb }}GB<br>
                    <strong>⏰ 保留期限：</strong>{{ config.retention_days }}天
                </div>
                <ul class="level-features">
                    {% for feature in config.features %}
                    <li>{{ feature }}</li>
                    {% endfor %}
                </ul>
                
                {% if current_user.user_level >= level %}
                    <button class="level-action" disabled>已拥有</button>
                {% elif level == 1 %}
                    <div class="level-price">需要 {{ config.points_required }} 积分</div>
                    <button class="level-action exchange" onclick="exchangePoints({{ level }})" 
                            {% if current_user.points < config.points_required %}disabled{% endif %}>
                        {% if current_user.points >= config.points_required %}
                            积分兑换
                        {% else %}
                            积分不足
                        {% endif %}
                    </button>
                {% else %}
                    <div class="level-price">¥ {{ config.price }} {% if level == 2 %}/ 月{% else %}/ 年{% endif %}</div>
                    <button class="level-action recharge" onclick="openRecharge({{ level }})">
                        充值开通
                    </button>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- 积分获取说明 -->
    <div style="background-color: #fff3e0; border-left: 4px solid #ff9800; padding: 20px; border-radius: 8px; margin-bottom: 40px;">
        <h4 style="margin-top: 0; color: #e65100;">💡 如何获取积分？</h4>
        <ul style="margin: 10px 0; padding-left: 20px; color: #666;">
            <li><strong>注册奖励：</strong>新用户注册即送 10 积分</li>
            <li><strong>每日登录：</strong>每天首次登录获得 1 积分</li>
            <li><strong>创建笔记：</strong>每创建一篇笔记获得 2 积分（待开发）</li>
            <li><strong>分享笔记：</strong>每次成功分享获得 5 积分（待开发）</li>
            <li><strong>活动奖励：</strong>参与平台活动可获得额外积分</li>
            <li><strong>管理员赠送：</strong>通过特殊渠道可获得积分奖励</li>
        </ul>
    </div>

    <!-- 积分记录 -->
    <div class="points-section">
        <h3 class="section-title">📜 积分记录（最近20条）</h3>
        {% if point_logs %}
        <div class="points-table">
            <table>
                <thead>
                    <tr>
                        <th>时间</th>
                        <th>变动</th>
                        <th>原因</th>
                        <th>余额</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in point_logs %}
                    <tr>
                        <td>{{ log.created_at|beijing_time }}</td>
                        <td>
                            {% if log.amount > 0 %}
                                <span class="points-positive">+{{ log.amount }}</span>
                            {% else %}
                                <span class="points-negative">{{ log.amount }}</span>
                            {% endif %}
                        </td>
                        <td>{{ log.reason }}</td>
                        <td><strong>{{ log.balance_after }}</strong></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="no-records">暂无积分记录</div>
        {% endif %}
    </div>

    <div style="text-align: center; margin-top: 40px;">
        <a href="{{ url_for('notes_page') }}" style="color: #667eea; text-decoration: none; font-size: 1.1em;">
            ← 返回笔记页面
        </a>
    </div>
</div>

<script>
const csrfToken = "{{ csrf_token() }}";

// 兑换码兑换
async function submitRedeemCode() {
    const code = document.getElementById('redeemCodeInput').value.trim().toUpperCase();
    
    if (!code) {
        alert('请输入兑换码！');
        return;
    }
    
    try {
        const response = await fetch('/redeem_code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({ code: code })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('🎉 ' + result.message);
            location.reload();
        } else {
            alert('❌ ' + result.error);
        }
    } catch (error) {
        alert('兑换失败：' + error.message);
    }
}

// 积分兑换会员
async function exchangePoints(level) {
    const levelName = {{ user_levels|tojson }};
    const config = levelName[level];
    
    if (!confirm(`确定要使用 ${config.points_required} 积分兑换${config.name}吗？`)) {
        return;
    }
    
    try {
        const response = await fetch('/exchange_points', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({ level: level })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('🎉 ' + result.message);
            location.reload();
        } else {
            alert('❌ ' + result.error);
        }
    } catch (error) {
        alert('兑换失败：' + error.message);
    }
}

// 充值开通会员
async function openRecharge(level) {
    const levelName = {{ user_levels|tojson }};
    const config = levelName[level];
    
    alert(`💰 充值功能开发中\n\n${config.name}\n价格：¥${config.price}\n\n请联系管理员手动开通会员`);
    
    // 实际使用时，这里应该跳转到支付页面
    // window.location.href = '/payment?level=' + level;
}

// 回车键提交兑换码
document.getElementById('redeemCodeInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        submitRedeemCode();
    }
});
</script>

{% endblock %}
